FLUJO DETALLADO DE LA BASE DE DATOS
=================================

Este documento explica, en lenguaje sencillo, cómo la base de datos `academia_final` soporta el flujo completo de la academia, desde que el administrador crea ciclos y cursos, hasta los reportes analíticos del dashboard.

1. USUARIOS, DOCENTES Y ESTUDIANTES
-----------------------------------

- Tabla `users`
  - Guarda los usuarios que pueden iniciar sesión en el sistema.
  - Columnas clave:
    - `username`, `password_hash`: datos de acceso.
    - `role`: define el tipo de usuario (`admin`, `student`, `teacher`).
    - `related_id`: apunta al registro asociado en `students` o `teachers` (según el rol).

- Tabla `teachers`
  - Guarda los datos de los docentes: nombre, DNI, teléfono, email, especialidad.

- Tabla `students`
  - Guarda los datos de los alumnos: DNI, nombre, apellidos, teléfonos y datos del apoderado.
  - Tiene también un `password_hash` para que el alumno pueda ingresar al sistema.

Relación con el flujo:
- **Admin**: es un registro en `users` con `role = 'admin'`.
- **Docente**: tiene un registro en `teachers` y normalmente un usuario en `users` con `role = 'teacher'` y `related_id = teachers.id`.
- **Alumno**: tiene un registro en `students` y un usuario en `users` con `role = 'student'` y `related_id = students.id`.

2. CICLOS, CURSOS, PAQUETES Y OFERTAS
-------------------------------------

- Tabla `cycles`
  - Representa cada ciclo académico o periodo.
  - Columnas importantes: `name`, `start_date`, `end_date`, `duration_months`, `status`.
  - El **Admin** "crea ciclo" registrando aquí un nuevo ciclo.

- Tabla `courses`
  - Guarda el catálogo de cursos (matemática, comunicación, etc.).
  - `base_price` define un precio base sugerido.

- Tabla `packages`
  - Representa paquetes de cursos (por ejemplo, paquete preuniversitario con varios cursos).

- Tabla `package_courses`
  - Une `packages` con `courses` (muchos a muchos).
  - Permite definir qué cursos pertenecen a cada paquete.

Ofertas por ciclo:

- Tabla `course_offerings`
  - Es la oferta concreta de un curso en un ciclo específico.
  - Columnas clave:
    - `course_id` → referencia a `courses`.
    - `cycle_id` → referencia a `cycles`.
    - `group_label` → nombre del grupo (por ejemplo, "Grupo A - Mañana").
    - `teacher_id` → docente asignado.
    - `price_override` → precio específico para este grupo (si es distinto al `base_price`).

- Tabla `package_offerings`
  - Oferta concreta de un paquete en un ciclo.
  - Similar a `course_offerings`, pero para paquetes.

- Tabla `package_offering_courses`
  - Relaciona una oferta de paquete (`package_offerings`) con las ofertas de cursos (`course_offerings`) que incluye.
  - Así se sabe exactamente qué grupos (ofertas de cursos) vienen dentro de una oferta de paquete específica.

Relación con el flujo:
- Cuando el **Admin agrega cursos y docentes** y luego **publica ofertas y define horarios**, en base de datos esto se ve como:
  - Nuevos registros en `courses`, `packages` y `teachers`.
  - Nuevos ciclos en `cycles`.
  - Nuevas ofertas de cursos en `course_offerings` y/o ofertas de paquetes en `package_offerings`.
  - Vinculación de ofertas de paquetes con ofertas de cursos via `package_offering_courses`.

3. HORARIOS DE CLASES
----------------------

- Tabla `schedules`
  - Define el horario de cada grupo/oferta de curso.
  - Columnas clave:
    - `course_offering_id` → a qué grupo de curso pertenece el horario.
    - `day_of_week` → día de la semana (Lunes, Martes, etc.).
    - `start_time`, `end_time` → hora de inicio y fin de clase.
    - `classroom` → aula.

Relación con el flujo:
- Cuando el **Admin define horarios**, se crean registros en `schedules` para cada `course_offering`.

4. MATRÍCULAS DE ALUMNOS
------------------------

- Tabla `enrollments`
  - Representa la matrícula de un alumno en un curso o en un paquete.
  - Columnas clave:
    - `student_id` → alumno que se matricula.
    - `course_offering_id` → si la matrícula es a un curso individual.
    - `package_offering_id` → si la matrícula es a un paquete.
    - `enrollment_type` → `course` o `package` (para saber de qué tipo es la matrícula).
    - `status` → estado de la matrícula (`pendiente`, `aceptado`, `rechazado`, `cancelado`).
    - `registered_at` → fecha de registro.
    - `accepted_by_admin_id`, `accepted_at` → quién y cuándo aceptó la matrícula.

Relación con el flujo:
- **Alumno se registra, elige curso o paquete y se matricula (pendiente)**:
  - Se crea el `student` (si no existía) y posiblemente su `user`.
  - Se genera un registro en `enrollments` con `status = 'pendiente'`.

- **Admin revisa voucher, acepta matrícula y activa acceso**:
  - Cuando el administrador aprueba el pago/matrícula, cambia el `status` de esa `enrollment` a `aceptado` y llena `accepted_by_admin_id` y `accepted_at`.

5. PAGOS, PLANES Y CUOTAS
-------------------------

- Tabla `payment_plans`
  - Define el plan de pago asociado a una matrícula.
  - Columnas clave:
    - `enrollment_id` → a qué matrícula pertenece el plan.
    - `total_amount` → monto total a pagar.
    - `installments` → número de cuotas.

- Tabla `installments`
  - Representa cada cuota individual del plan de pago.
  - Columnas clave:
    - `payment_plan_id` → plan al que pertenece la cuota.
    - `installment_number` → número de cuota (1, 2, 3, ...).
    - `amount` → monto de esa cuota.
    - `due_date` → fecha de vencimiento.
    - `paid_at` → cuándo se pagó efectivamente (si ya está pagada).
    - `status` → `pending`, `paid` o `overdue`.
    - `voucher_url` → enlace o referencia al voucher subido por el alumno.
    - `rejection_reason` → motivo de rechazo del voucher (si el admin lo rechaza).

Relación con el flujo:
- El sistema puede **avisar por cuotas vencidas** revisando las cuotas en `installments` con:
  - `status = 'pending'` y `due_date` anterior a la fecha actual → se consideran vencidas.

6. ASISTENCIAS DE LOS ALUMNOS
-----------------------------

- Tabla `attendance`
  - Guarda el registro de asistencia de cada alumno.
  - Columnas clave:
    - `student_id` → alumno.
    - `schedule_id` → referencia al horario específico de la clase.
    - `date` → fecha de la clase.
    - `status` → `presente` o `ausente`.

Relación con el flujo:
- Cuando el **Docente marca asistencias**, el sistema crea o actualiza registros en `attendance` para cada alumno en la clase.

7. NOTIFICACIONES A APODERADOS
------------------------------

- Tabla `notifications_log`
  - Registra cada notificación que se envía.
  - Columnas clave:
    - `student_id` → alumno afectado.
    - `parent_phone` → número al que se mandó el mensaje.
    - `type` → tipo de notificación (`absences_3`, `payment_due`, `other`).
    - `message` → texto enviado.
    - `sent_at` → cuándo se envió.
    - `status` → `pending`, `sent`, `failed`.

Relación con el flujo y eventos automáticos:
- **Evento automático: avisa por 3 faltas**
  - El sistema cuenta las ausencias (`status = 'ausente'`) en `attendance` para un alumno.
  - Cuando llega a 3, genera una notificación en `notifications_log` con `type = 'absences_3'`.

- **Evento automático: avisa por cuotas vencidas**
  - El sistema revisa `installments` con `status = 'overdue'` o `pending` y `due_date` vencida.
  - Por cada caso genera una notificación en `notifications_log` con `type = 'payment_due'`.

- **Evento automático: limpia notificaciones viejas**
  - Periódicamente se pueden borrar o marcar como archivadas ciertas notificaciones, según lógica de negocio. Esa limpieza se puede hacer directamente sobre `notifications_log` (por ejemplo, eliminando registros muy antiguos o moviéndolos a otra tabla, si se definiera).

8. TABLA ANALÍTICA PARA EL DASHBOARD
------------------------------------

- Tabla `analytics_summary`
  - Sirve como tabla resumen para hacer el dashboard más rápido.
  - Columnas clave:
    - `student_id` → alumno.
    - `cycle_id` → ciclo.
    - `attendance_pct` → porcentaje de asistencia del alumno en ese ciclo.
    - `total_paid` → cuánto ha pagado en total en ese ciclo.
    - `updated_at` → última vez que se recalculó.

Relación con el flujo:
- **Admin Dashboard ve reportes analíticos (asistencia + pagos)**:
  - El sistema puede recalcular periódicamente `analytics_summary` en base a:
    - Asistencias de `attendance`.
    - Pagos registrados en `installments` (`status = 'paid'`).
  - El dashboard lee de `analytics_summary` para mostrar rápidamente estadísticas sin recalcular todo cada vez.

9. RESUMEN DEL FLUJO COMPLETO
-----------------------------

1) **Admin crea ciclo, cursos, paquetes y ofertas**
   - Tablas usadas: `cycles`, `courses`, `packages`, `package_courses`, `course_offerings`, `package_offerings`, `package_offering_courses`, `schedules`.

2) **Alumno se registra y se matricula en curso o paquete**
   - Tablas usadas: `students`, `users`, `enrollments`, `payment_plans`, `installments`.

3) **Admin revisa pagos (vouchers) y acepta la matrícula**
   - Tablas usadas: `installments` (voucher, estado, rechazo), `payment_plans`, `enrollments` (cambio de `status` a `aceptado`).

4) **Docente marca asistencias**
   - Tablas usadas: `attendance`, relacionando `students` con `schedules`.

5) **Eventos automáticos (notificaciones por faltas y cuotas vencidas)**
   - Tablas usadas: `attendance`, `installments`, `notifications_log`.

6) **Admin ve dashboard analítico**
   - Tablas usadas: principalmente `analytics_summary`, que se alimenta de `attendance`, `installments`, `enrollments` y `cycles`.

Con esto, cualquier persona puede entender cómo cada parte del flujo funcional (admin, alumno, docente y eventos automáticos) está reflejada y soportada por las tablas y relaciones de la base de datos `academia_final`.
